<template>
  <div>
    <portal to="header-left">
      <div class="page-title float-left">
        <div class="float-left pt-2">
          <h1 class="text-gray-700 dark:text-gray-200 text-base m-0">Үнсэн</h1>
          <h2 class="text-gray-400 text-xs m-0"><span>Сонгогдийн мэдээлэл</span></h2>
        </div>
      </div>
    </portal>
    <div class="grid md:grid-cols-12 grid-cols-1 gap-2">
      <div id="map" class="col-span-12 lg:col-span-8"></div>
      <div class="col-span-12 lg:col-span-4">

        <div class="crm-on-mapstyles__CRMOnMapOverlay-sc-1t1jutn-0 iDOdkd">
          <div class="core-result-generalsstyles__OuterContainer-sc-1t46y8j-0 LLaaP">
            <div color="#FF4A43" class="core-result-generalsstyles__WinningTab-sc-1t46y8j-3 iHPAGD"></div>
            <div class="core-result-generalsstyles__Container-sc-1t46y8j-1 gmVuGx">
              <div class="core-result-generalsstyles__ContainerInner-sc-1t46y8j-2 ixHOBW">
                <div class="core-result-generals-headerstyles__CRMGHeader-iinac4-0 crZsYa">
                  <div class="core-result-generals-headerstyles__HeaderSide-iinac4-1 jGaOtC">
                    <div class="core-result-generals-headerstyles__StateInfoWrapper-iinac4-2 hxnmRO">
                      <div class="core-result-generals-headerstyles__StateInfoWrapperLeft-iinac4-3 cLGfYg">
                        <div class="core-result-generals-headerstyles__WrapTogether-iinac4-5 gPwQqV">
                          <div class="core-result-generals-headerstyles__RaceName-iinac4-6 gGlTLu"> President: Wyoming
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="core-result-generals-headerstyles__CRMGSubtitle-iinac4-8 zzkFV">
                      <div class="core-result-generals-headerstyles__FFSCrmElectoralVotes-iinac4-10 jdHWbA">3 electoral
                        votes
                      </div>
                    </div>
                  </div>
                  <div class="core-result-generals-headerstyles__ProjectedWinnerSide-iinac4-11 gfHcHg">
                    <div class="core-result-generals-headerstyles__FFSRWinnerContainer-iinac4-13 jdFNnD">
                      <div color="#FF4A43" class="core-result-generals-headerstyles__Winner-iinac4-14 ilniXY">Trump
                      </div>
                      <span class="core-result-generals-headerstyles__CheckmarkWrapper-iinac4-15 cdGUre"><svg width="16"
                                                                                                              height="16"
                                                                                                              viewBox="0 0 16 16"
                                                                                                              version="1.1"
                                                                                                              xmlns="http://www.w3.org/2000/svg"><title>icon / checkmark</title><g
                        id="icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g
                        id="icon-/-checkmark--/-dem"><path
                        d="M0,8 C0,12.4181333 3.58186667,16 8,16 C12.4181333,16 16,12.4181333 16,8 C16,3.5816 12.4181333,0 8,0 C3.58186667,0 0,3.5816 0,8 Z"
                        id="path-1-copy" fill="#FF4A43"></path><path
                        d="M13.5967059,5.98070588 L8.248,11.3294118 L7.24329412,12.3341176 C7.10541176,12.472 6.93788235,12.5407059 6.74117647,12.5407059 C6.544,12.5407059 6.37647059,12.472 6.23858824,12.3341176 L5.23435294,11.3294118 L2.55952941,8.65505882 C2.42164706,8.51717647 2.35294118,8.34964706 2.35294118,8.15294118 C2.35294118,7.95576471 2.42164706,7.78823529 2.55952941,7.65035294 L3.56470588,6.64564706 C3.70258824,6.50823529 3.86964706,6.43905882 4.06682353,6.43905882 C4.264,6.43905882 4.43105882,6.50823529 4.56894118,6.64564706 L6.74117647,8.82494118 L11.5872941,3.97129412 C11.7247059,3.83341176 11.8922353,3.76470588 12.0894118,3.76470588 C12.2865882,3.76470588 12.4541176,3.83341176 12.592,3.97129412 L13.5967059,4.976 C13.7345882,5.11435294 13.8032941,5.28188235 13.8032941,5.47858824 C13.8032941,5.67529412 13.7345882,5.84282353 13.5967059,5.98070588 Z"
                        id="Fill-1" fill="#FFFFFF"></path></g></g></svg></span></div>
                    <div color="#FF4A43" class="core-result-generals-headerstyles__FFSRProjectedWinner-iinac4-12 KlVaL">
                      projected winner
                    </div>
                    <div class="follow-this-racestyles__FollowThisRaceContent-ozeam6-5 eekZEV">
                      <div
                        class="follow-this-racestyles__RaceButtonBase-ozeam6-0 follow-this-racestyles__FollowButton-ozeam6-2 dOIfHF">
                        + Follow
                      </div>
                    </div>
                  </div>
                </div>
                <table class="core-result-generals-tablestyles__Table-sc-1d02ybh-0 datsGf">
                  <thead class="core-result-generals-tablestyles__Thead-sc-1d02ybh-4 dmvnun">
                  <tr class="core-result-generals-tablestyles__Tr-sc-1d02ybh-3 hPoGgN">
                    <th
                      class="core-result-generals-tablestyles__Th-sc-1d02ybh-1 core-result-generals-tablestyles__ThName-sc-1d02ybh-6 iAgNGg">
                      Candidate
                    </th>
                    <th data-testid="gcrm-percentage-header"
                        class="core-result-generals-tablestyles__Th-sc-1d02ybh-1 core-result-generals-tablestyles__FFSRThPercent-sc-1d02ybh-8 dQNHZM">
                      %
                    </th>
                    <th data-testid="gcrm-vote-header"
                        class="core-result-generals-tablestyles__Th-sc-1d02ybh-1 core-result-generals-tablestyles__FFSRThVotes-sc-1d02ybh-12 jFutWo">
                      Votes
                    </th>
                  </tr>
                  </thead>
                  <tbody data-testid="gcrm-table-body"
                         class="core-result-generals-tablestyles__Tbody-sc-1d02ybh-5 llSLVh">
                  <tr class="core-result-generals-tablestyles__Tr-sc-1d02ybh-3 eMassY">
                    <td
                      class="core-result-generals-tablestyles__Td-sc-1d02ybh-2 core-result-generals-tablestyles__TdName-sc-1d02ybh-7 jeeVBj">
                      <div class="core-result-generals-tablestyles__FlexWrapper-sc-1d02ybh-15 RlMPC">
                        <div class="core-result-generals-tablestyles__CandidateContentWrapper-sc-1d02ybh-16 bbYtmu">
                          <div color="#FF4A43"
                               class="core-result-generals-tablestyles__PartyDot-sc-1d02ybh-14 eGqrJN"></div>
                          <div class="core-result-generals-tablestyles__Name-sc-1d02ybh-17 fIbwoL"><span>Trump</span>
                            <div class="core-result-generals-tablestyles__Incumbent-sc-1d02ybh-18 lhjspJ"></div>
                          </div>
                        </div>
                        <div class="core-result-generals-tablestyles__FFSRTableCheckmarkWrapper-sc-1d02ybh-23 gHXDU">
                          <svg width="16" height="16" viewBox="0 0 16 16" version="1.1"
                               xmlns="http://www.w3.org/2000/svg"><title>icon / checkmark</title>
                            <g id="icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                              <g id="icon-/-checkmark--/-dem">
                                <path
                                  d="M0,8 C0,12.4181333 3.58186667,16 8,16 C12.4181333,16 16,12.4181333 16,8 C16,3.5816 12.4181333,0 8,0 C3.58186667,0 0,3.5816 0,8 Z"
                                  id="path-1-copy" fill="#FF4A43"></path>
                                <path
                                  d="M13.5967059,5.98070588 L8.248,11.3294118 L7.24329412,12.3341176 C7.10541176,12.472 6.93788235,12.5407059 6.74117647,12.5407059 C6.544,12.5407059 6.37647059,12.472 6.23858824,12.3341176 L5.23435294,11.3294118 L2.55952941,8.65505882 C2.42164706,8.51717647 2.35294118,8.34964706 2.35294118,8.15294118 C2.35294118,7.95576471 2.42164706,7.78823529 2.55952941,7.65035294 L3.56470588,6.64564706 C3.70258824,6.50823529 3.86964706,6.43905882 4.06682353,6.43905882 C4.264,6.43905882 4.43105882,6.50823529 4.56894118,6.64564706 L6.74117647,8.82494118 L11.5872941,3.97129412 C11.7247059,3.83341176 11.8922353,3.76470588 12.0894118,3.76470588 C12.2865882,3.76470588 12.4541176,3.83341176 12.592,3.97129412 L13.5967059,4.976 C13.7345882,5.11435294 13.8032941,5.28188235 13.8032941,5.47858824 C13.8032941,5.67529412 13.7345882,5.84282353 13.5967059,5.98070588 Z"
                                  id="Fill-1" fill="#FFFFFF"></path>
                              </g>
                            </g>
                          </svg>
                        </div>
                      </div>
                    </td>
                    <td data-testid="gcrm-percentage-cell"
                        class="core-result-generals-tablestyles__Td-sc-1d02ybh-2 core-result-generals-tablestyles__FFSRTdPercent-sc-1d02ybh-9 fLtFjI">
                      69.9%
                    </td>
                    <td data-testid="gcrm-vote-cell"
                        class="core-result-generals-tablestyles__Td-sc-1d02ybh-2 core-result-generals-tablestyles__FFSRTdVotes-sc-1d02ybh-13 gwqxFH">
                      193,559
                    </td>
                  </tr>
                  <tr class="core-result-generals-tablestyles__Tr-sc-1d02ybh-3 eMassY">
                    <td
                      class="core-result-generals-tablestyles__Td-sc-1d02ybh-2 core-result-generals-tablestyles__TdName-sc-1d02ybh-7 jeeVBj">
                      <div class="core-result-generals-tablestyles__FlexWrapper-sc-1d02ybh-15 ebLWUP">
                        <div class="core-result-generals-tablestyles__CandidateContentWrapper-sc-1d02ybh-16 bbYtmu">
                          <div color="#1A6AFF"
                               class="core-result-generals-tablestyles__PartyDot-sc-1d02ybh-14 gGmoMo"></div>
                          <div class="core-result-generals-tablestyles__Name-sc-1d02ybh-17 fIbwoL"><span>Biden</span>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td data-testid="gcrm-percentage-cell"
                        class="core-result-generals-tablestyles__Td-sc-1d02ybh-2 core-result-generals-tablestyles__FFSRTdPercent-sc-1d02ybh-9 fLtFjI">
                      26.6%
                    </td>
                    <td data-testid="gcrm-vote-cell"
                        class="core-result-generals-tablestyles__Td-sc-1d02ybh-2 core-result-generals-tablestyles__FFSRTdVotes-sc-1d02ybh-13 gwqxFH">
                      73,491
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
              <div class="core-result-generals-footerstyles__Footer-sc-1c6sqkf-0 hnNOKL">
                <div class="core-result-generals-footerstyles__Updates-sc-1c6sqkf-1 eULQic">
                  <div class="core-result-generals-footerstyles__UpdateInProgress-sc-1c6sqkf-8 ekmRNX">
                    <div class="core-result-generals-footerstyles__FFSREst-sc-1c6sqkf-6 lfbFtM">Est. 99% In</div>
                  </div>
                  <div class="core-result-generals-footerstyles__FFSRLastUpdated-sc-1c6sqkf-3 gZesqy">Updated 08:22 a.m.
                    ET, Nov. 24
                  </div>
                </div>
                <div class="core-result-generals-footerstyles__FullStateDetailsWrapper-sc-1c6sqkf-9 eJmvkm"><a
                  href="/election/2020/results/state/wyoming/president"
                  class="core-result-generals-footerstyles__FullStateDetails-sc-1c6sqkf-5 gQmmQx">Full Details</a></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-span-12">bottom</div>
    </div>
  </div>
</template>

<script setup>
import {onMounted, ref} from 'vue';
import L from 'leaflet';
import "leaflet/dist/leaflet.css";
import * as d3 from 'd3';

const map = ref(null);
const provinceLayer = ref(null);

// Define the default style
// Define the default style
const blueStyle = {
  color: '#ffffff',
  weight: 1,
  opacity: 1,
  fillOpacity: 1,
  stroke: true,
  dashArray: null,
  fillColor: '#1a6aff', // Same as color to fill
  fill: true,
  lineCap: 'round',
  lineJoin: 'round',
  strokeColor: '#ffffff' // White stroke color
};

// Define the style for specific provinces to be red
const redStyle = {
  color: '#ffffff',
  weight: 1,
  opacity: 1,
  fillOpacity: 1,
  stroke: true,
  dashArray: null,
  fillColor: '#ff4a43', // Same as color to fill
  fill: true,
  lineCap: 'round',
  lineJoin: 'round',
  strokeColor: '#ffffff' // White stroke color
};

// Function to determine the style of each province
function getStyle(feature) {
  // Adjust the condition to match the property you want to check
  if (feature.properties.name === 'Khentii') {
    return blueStyle;
  }
  return redStyle;
}

// Load soums GeoJSON based on province_id
function loadSoums(name) {
  d3.json('/election/map/soums/' + name + '.json').then((soumData) => {
    const soumLayer = L.geoJSON(soumData, {
      onEachFeature: onEachSoum,
      style: redStyle // Apply the default style to soums
    }).addTo(map.value);

    // Add a button to go back to province view
    const backButton = L.control({position: 'topright'});
    backButton.onAdd = function () {
      const div = L.DomUtil.create('div', '');
      div.innerHTML = '<a href="#" title="Улсын хэмжээнд харах" class="px-2">Буцах</a>';
      div.onclick = function () {
        map.value.removeLayer(soumLayer);
        map.value.removeControl(backButton);
        map.value.setView([46.8625, 103.8467], 5); // Reset view to show all provinces
        map.value.addLayer(provinceLayer.value);
      };
      return div;
    };
    backButton.addTo(map.value);
  });
}

function onEachSoum(feature, layer) {
  layer.bindTooltip(feature.properties.NAME, {permanent: false, sticky: true, direction: 'auto'});
  // Add any soum-specific interactions here
}

function onEachProvince(feature, layer) {
  layer.bindTooltip(feature.properties.name_MN, {permanent: false, sticky: true, direction: 'auto'});

  layer.on('click', (e) => {
    map.value.removeLayer(provinceLayer.value);
    loadSoums(feature.properties.name);
    map.value.fitBounds(layer.getBounds()); // Zoom to the selected province

    // Close any open tooltips
    map.value.eachLayer(function (l) {
      if (l.getTooltip && l.getTooltip()) {
        l.closeTooltip();
      }
    });

    L.DomEvent.stopPropagation(e);
  });
}

function initMap() {
  // Initialize the map
  map.value = L.map('map').setView([46.8625, 103.8467], 5);

  // Add a tile layer
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '',
    maxZoom: 18,
  }).addTo(map.value);

  // Load province GeoJSON
  d3.json('/election/map/mongoliaLow.json').then((provinceData) => {
    provinceLayer.value = L.geoJSON(provinceData, {
      onEachFeature: onEachProvince,
      style: getStyle // Apply the style based on the feature properties
    }).addTo(map.value);
  });
}

onMounted(() => {
  initMap();
});
</script>

<style>
#map {
  padding-bottom: 65%;

}

.leaflet-control-attribution {
  display: none !important;
}

.leaflet-control-zoom {
  border: none !important;
  box-shadow: rgba(0, 0, 0, 0.15) 0px 0.1rem 0.3rem 0px, rgba(0, 0, 0, 0.15) 0px 0.1rem 0.5rem 0px;
}

svg path {
  &:focus {
    outline: none;
  }
}


</style>
